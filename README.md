# Медиабаинговая система

Проект представляет собой новостную витрину с рекламными 
лендингами, системой внутренних тизеров и аналитики. 

- Тимлид и архитектор - Павел.
- Менеджер проекта - Денис.

## Организационная часть

### Регламент по работе с задачами
- Задачи в разработку можно брать со статусом `TO DO`. Если у задачи при этом не указан исполнитель, то ее может взять любой желающий указав исполнителем себя.
- Приоритет имеют задачи с тегом "приоритет" и установленные на сегодняшнюю дату. 
- При начале работы над задачей смените статус на `Doing`.
- Одна задача - одна ветка. 
- Ветки создавать из интерфейса гитлаба через выпадающее меню кнопки `Create merge request`. 
В этом случае между задачей и реквестом создается связь, что обеспечивает удобные дополнительные возможности.
- Если к концу рабочего дня задача завершена не до конца, то в комментариях к ней надо написать, что сделано.
- В конце рабочего дня обязательно должен быть пуш кода в ветку задачи. 
- После завершения работы над задачей ее надо отправить на ревью. Статус задачи меняем на `Review`. 
Далее в заголовке реквеста убираем `WIP: ` (work in progress) и назначем реквест на Pavel @pawelfcdd.

### Регламент по работе с реквестами
- Реквест создается при начале работы над задачей.
- Реквест создается из интерфейса гитлаба через выпадающее меню кнопки `Create merge request`.
- При создание реквеста надо дополнительно указать имя создаваемой ветки. Имя ветки должно быть `task_number-short_eng_task_name`. Например `42-readme-refactoring`.
- Заголок реквеста создается автоматически из заголовка задачи.
- При завершение задачи из заголовка убирается `WIP: ` (work in progress) и назначем реквест на ревью Pavel @pawelfcdd.
- Реквест не должен иметь конфликтов с веткой `develop`.
- Обсуждение реквеста идет в комментариях к нему.
- Реквесты в `develop` могут мержить Павел или Денис.
- Решенные треды в комментариях должны закрываться ревьювером.

### Регламент по организации рабочих процессов
- В рабочий день необходимо отработать минимум 4 часа. За неделю минимум 20. Больше можно :)
- Свой рабочий график планируете самостоятельно.
- Постарайтесь оперативно отвечать на рабочий вопросы в Телеграме.
- Для ведения задач используем встроенный инструмент гитлаба.
- Для общения проектный чат в Телеграме. Все рабочие вопросы должны обсуждаться в нем.

### Регламент по отчетам
- Дневной отчет для заказчика формируется в 7:00 МСК днем следующим за днем отчета. Отчет содержит затреканное время, над чем работали и над чем планируем работать.
- Недельный отчет для заказчика формируется в 19:00 МСК субботы отчетной недели. Отчет содержит затреканное время, над чем работали и над чем планируем работать.
- Отчет формируется из данных HubStuff, статусов задач и комментариях в них, а так же дополнительной информации в чате проекта.

### Регламент по работе с кодом и коммитами
- Код оформляем согласно стандартам PSR-1, PSR-2, PSR-4, PSR-12. Если в редакторе есть галочка автоформатирования обязательно ее включать для измененного кода.
- Комментарии пишем на русском. 
- Коммиты пишем на русском. Сперва заголовок в одно предложение, потом пояснение в теле коммита. Более подробно <https://habr.com/ru/post/416887/> 
- Переменные, классы, файлы, роуты - называем английскими словами.
- Все названия файлов, имена переменных, методов и классов должны быть осмысленными и говорящими.
- Для изменений в базе используем миграции.
- Для каждого модуля обязательно создаем сеты тестовых данных (DataFixtures), которые заполнят базу тестовыми данными при установке системы на сервере или запуске локально.

### Регламент по обновлению ветки фичи от основной ветки
1. `git checkout develop` # Переключиться на основную ветку
1. `git pull origin develop` # Обновить ее
1. `git checkout xx-feature-branch` # Переключиться на ветку фичи
1. `git rebase develop` # Подтянуть все изменения в нее. При этом все ваши коммиты, которые нет в ветке develop будут перемещены вверх по истории
1. При необходимости решить конфликты
1. `git push --force origin xx-feature-branch` # Запушить ветку фичи с флагом `--force`. Хеши ваших коммитов изменились после ребейса. Теперь что бы запушить нужен этот флаг.

**Для чего это необходимо?**

1. При мерже ветки develop все изменения оттуда, которых у вас нет становятся частью ваших изменений. Порой это тысячи строк кода. После этого делать ревью становится очень проблематично и трудозатратно.
2. Становится меньше ветвлений в истории изменений кода и она становится проще для восприятия.

### Регламент по работе в команде от Сергея

1. Скриншоты трекера. На скринах не должно быть ничего лишнего. В частности: Список проектов, ВК,
Youtube, Музыка, Чат с данными по другому проекту, Пароли проектов (любых, в том числе того, над которым работаете),
Прочее не относящееся к работе над проектом.
В конце рабочего дня проверяйте созданные скриншоты по ссылке - https://app.hubstaff.com/organizations/45838/activities 
Если обнаружите лишний скрин, сообщите мне одним списком в конце недели. Если по какой то причине подобный скрин обнаружу я или клиент, то за каждый будет вычитаться 1 час выплаты. 
Сообщили о лишнем скрине - сняли с себя ответственность, вычета в таком случае не будет. Оставили скрин без внимания - минус час. 

2. Запрещены пароли типа 123456, qwerty, стандартные пароли установленной системы или использования одного и того же пароля дважды, на любых проектах. 
Советую использовать KeePass https://keepass.info/ там очень удобно можно хранить пароли, на скринах их не будет в открытом виде, база шифруется, можно создавать группы, чтобы не искать пароли по чатам или текстовым документам. Также есть встроенный генератор паролей по маске. Не храните пароли от проектов в открытом виде.

3. Если вы работаете с клиентом/архитектором в чате напрямую, то обязательно оценивать в часах все поступающие от них задачи, без подтверждения оценки от меня/архитектора/клиента задачу выполнять запрещено. Вообще все задачи запрещено выполнять без оценки и подтверждения. 
Бывают проекты-исключения, где оценка не нужна, об этом отдельно сообщу вам я или клиент/архитектор.
Если начали работу без соответствующего подтверждения, то эти часы оплачены не будут. 

4. Необходимо предупреждать о  болезни / форс мажоре / отъезде, любой другой жизненной ситуации когда вы вынуждены приостановить работу над проектом на какой то срок. Если вы уезжаете во время, когда у вас нет задач, то желательно тоже предупреждать, т.к. я всегда стараюсь загрузить вас работой, это мне сильно поможет в понимании могу ли я взять проект в работу под вас или я от него откажусь/передам другому разработчику. 
По умолчанию я всегда считаю что вы свободны и можете начать в течение 24 часов полноценную работу над моей задачей, если не было предупреждения.

5. Не должно быть файлов, в которых прописаны пароли доступов к серверам и при этом доступ к файлу расшарен вообще всем подряд по ссылке. 

6. Запрещено расшаривание доступа к гуглдокам по общей ссылке, доступ должен быть только для запрошенных аккаунтов.

Срока годности для правил нет, если косяк выяснится в ноябре, а инцидент был в апреле, то будут применены соответствующие меры. Эти правила очень важны, они простые и не требуют от вас особых усилий, не меняют формат вашей работы. 

## Техническая часть

Разработка ведется на Symfony 5. Монолит.

### Тестовый сервер разработчиков

- Новостная витрина <http://0315.devsit.ru/>
- Панель Админа: <http://0315.devsit.ru/admin>
- Панель Медиабаера: <http://0315.devsit.ru/mediabuyer>
- Панель Журналиста: <http://0315.devsit.ru/journalist>

### Тестовый сервер заказчика

- Новостная витрина <https://digest.agency/>
- Панель Админа: <https://digest.agency/admin>
- Панель Медиабаера: <https://digest.agency/mediabuyer>
- Панель Журналиста: <https://digest.agency/journalist>

### Доступ на тестовые сервера
Доступ возможен по ssh по ключу. Для этого надо его публичную часть в телеграмме прислать Денису. 
Логин `forge`. Sudo пароль указан в блоках соответствующих серверов в wiki проекта.

### Тестовые пользователи
Создаются при запуске сидов. Пароли для всех `112233`.

- admin1@demo.com - активен
- admin2@demo.com - деактивирован
- news1@demo.com - активен
- news2@demo.com - активен
- news3@demo.com - деактивирован
- buyer1@demo.com - активен
- buyer2@demo.com - активен
- buyer3@demo.com - деактивирован

### Требования к системе

- PHP 7.3 или выше
- MySQL 5.7 или выше
- Docker 19.03 или выше
- Docker-compose 1.24 или выше
- node 10.20 или выше
- npm 6.14 или выше
- Git

### Файловая структура репозитория

Проект контейнеризован, `Dockerfile` а так же файлы проекта находятся внутри
директории `mnt`

```
├── mnt
│   ├── app
|   |   ├── bin
|   |   ├── config
|   |   ├── public
|   |   ├── src
|   |   ├── templates
|   |   ├── tests
|   |   ├── translations
|   |   ├── .env
|   |   ├── .env.local.dist
|   |   ├── .env.test
|   |   ├── .gitignore
|   |   ├── composer.json
|   |   ├── phpunit.xml.dist
│   ├── docker
|   |   ├── vhosts
|   |   ├── Dockerfile
|   |   ├── php.ini
├── .gitignore
└── docker_compose.yml
```

Перед запуском проекта

### Запуск проекта в продакшене

1. Установить imagick
1. Установить redis
1. В конфиг nginx добавить следующий блок блок **previews** (смотри ниже) 
1. Выполнить команду `composer install`
1. Выполнить команду `cp .env.local.dist .env.local`
1. Выполнить команду `cp config/counters.yaml.dist config/counters.yaml`
1. Выполнить команду `cp config/basic-settings.yaml.dist config/basic-settings.yaml`
1. Выполнить команду `chmod 766 config/counters.yaml`
1. Выполнить команду `chmod 766 config/basic-settings.yaml`
1. Перейти в директорию `cd public/assets`
1. Выполнить команду `npm i`
1. Выполнить команду `bin/console doctrine:database:create && bin/console doctrine:schema:update --force` для развертывания структуры базы
1. _Выполнить команду для заполнения БД обязательными данными_
1. Выполнить команду `bin/console app:user:add` для добавления пользователя с ролью Администратор
1. В .env.local указать используемое окружение. Например: prod
1. _На папку с изображениями необходимо установить права для динамического создания подпапок и preview-изображений_
1. _Настроить работу кронов_
1. в настройках mysql должна быть отключена директива only_full_group_by (лучше прописать в файле my.cnf, чтобы настройки не сбрасывались при перезагрузке сервера)

**previews**
```  
location /previews/ {
    alias /path_to_server_root/uploads/images/;
    try_files $uri $uri/ /index.php?$query_string;
} 
```
где `path_to_server_root` путь до корня веб-сервера

### Запуск проекта на локальной среде

1. Клонировать проект
1. Перейти в папку с проектом
1. В папке проекта открыть командную строку и выполнить команду `docker-compose up -d --build app`
1. Запустить cron внутри контейнера `make cron`
1. Убедиться в наличии изображений в папке, указанной в .env как SOURCE_IMAGES_PATH Если изображения отсутствуют, выполнить команду `bin/console app:parse:images` 
1. Далее нужно войти в терминал контейнера приложения (в нашем случае это `app`). Для этого в командной строке
нужно выполнить следующую команду `docker-compose exec app bash`
1. Выполнить команду `cp .env.local.dist .env.local`
1. Выполнить команду `cp config/counters.yaml.dist config/counters.yaml`
1. Выполнить команду `cp config/basic-settings.yaml.dist config/basic-settings.yaml`
1. Выполнить команду `chmod 766 config/counters.yaml`
1. Выполнить команду `chmod 766 config/basic-settings.yaml`
1. Выполнить команду `composer install`
1. Выполнить команду `bin/console doctrine:database:create && bin/console doctrine:schema:update --force`
1. Выполнить команду `bin/console doctrine:fixtures:load --append`
1. Перейти в директорию `cd public/assets`
1. Выполнить команду `npm i`

Возможные проблемы при установке:
При возникновении ошибки в manifest.json проверить json_manifest_path в /mnt/app/config/packages/assets.yaml, он должен выглядеть так:
framework:
  assets:
    json_manifest_path: '%kernel.project_dir%/public/build/manifest.json'


#### Команды для Docker для быстрого запуска из консоли
|  Команда | Описание  |
|---|---|
| `make start`          | Запуск контейнеров Docker                                                                             |
| `make start-build`    | Запуск сборки контейнеров Docker                                                                             |
| `make stop`           | Остановка контейнеров Docker                                                                                |
| `make restart`        | Перезапуск контейнеров Docker                                                                             |
| `make update`         | Запустить обновление проекта                                                              |
| `make bash`           | Запуск bash-сессии для контейнера app (контейнер с веб-приложением)                                                       |
| `make build`          | Запуск команды единоразовой сборки JS и CSS файлов                           |
| `make watch`          | Запуск команды сборки JS и CSS файлов "на лету"                                                    |
| `make npm-install`    | Установка зависимостей NPM
| `make ps`             | Вывести список всех контейнеров
| `make cache-clear`    | Очистка кэша приложения
| `make cron`           | Запуск крона

#### Обновление развернутого локально проекта
1. Выполнить команду `chmod +x update.sh `
1. Запустить скрипт обновления командой `. update.sh `
1. В контекстном меню выбрать Обновление проекта (1) либо повторное создание базы данных (2)

#### После установки
Если установка прошла успешно, проект будет доступен по адресу
- Новостная витрина <http://172.0.0.3/>
- Панель Админа: <http://172.0.0.3/admin>
- Панель Медиабаера: <http://172.0.0.3/mediabuyer>
- Панель Журналиста: <http://172.0.0.3/journalist>

#### Для тестирования фильтрации конверсий необходимо:
После выполнения фикстур сгенерировать конверсиям фейковую дату создания командой -

`bin/console app:conversions:redate`

### Для парсинга таблицы с переводами городов необходимо:
Выполнить команду - `bin/console app:parse:geo` 

### Для получения letsencrypt сертификата:
Выполнить команду - `app:letsencrypt:domain {domain}` где domain - название необходимого домена

### Для автоматического letsencrypt сертификата:
Команда - `app:auto-letsencrypt:domain` автоматически берет домены из таблицы `domain_parking` у которых отсутствует сертификат,
либо срок действия сертификата истекает менее чем через неделю и генерирует новый сертификат.

### Для того чтобы поставить консольную команду на крон:
Необходимо создать метод в `/src/Service/Schedule/AppScheduleBuilder.php`

Очень подробная документация - https://github.com/zenstruck/schedule-bundle

Посмотреть список текущих крон заданий - `bin/console schedule:list --detail`

Конфигурация cron для работы бандла -
```
PATH=/bin:/usr/local/bin
SHELL=/bin/bash

* * * * * php /path/to/project/bin/console schedule:run >> /dev/null 2>&1
```


#### Дата-атрибуты для сортировки в таблицах
Для манипуляций с сортировкой нужно добавлять дата-атрибуты в заголовок колонки:

Чтобы колонку можно было сортировать data-sortable-column="active"
Чтобы колонка стала дефолтной для таблицы
data-sortable-order="asc" или data-sortable-order="desc"

Также изменилось формирование колонок на бекенде для автоматизации процесса добавления этих атрибутов. Пример передачи массива колонок:
```
$columns = [
            [
                'label' => 'ID', //Название колонки
                'defaultTableOrder' => 'asc', //Является дефолтной для всей таблицы с сортировкой "asc"
                'sortable' => true //Можно сортировать
                'paging' => 0 //Отключает пагинацию, по дефолту пагинация включена
                'pagingServerSide' => true //Активация сервер-сайд пагинации
                'ajaxUrl' => {url} // урл для аякс запроса для пагинации
                'seraching' => false // отключает поиск по таблице(необязательный параметр, по дефолту поиск включен),
                'binfo' => false // скрывает текст "Показаны с 1 по Х запись из ХХ записей" (по дефолту включено),
                'columnName' => {string} // название колонки, необходимо для server side сортировки
            ],
            ...
]         
```
Обязательно только поле label

#### Кастомные фильтры для Twig
``` custom_slice($from, $to)``` или ```custom_slice($to)```
можно использовать вместо стандартного slice() для работы со строками. Если место обрезки заканчивается на комментарии, он удлинняет фрагмент так что бы комментарий полностью влез.
```teasers_click_counter_link(array $teaser, ?\App\Entity\News $news, array {'pageType': 'top'})```
генерирует ссылку на счётчик кликов по тизеру. Параметр $news необязательный, pageType может быть full, short, top

#### Настройки загрузчика изображений (в .env)
IMAGE_UPLOADER_MAX_SIZE - максимальный размер загружаемого файла (указывать в Кб или Мб, например, 300Кб)
IMAGE_UPLOADER_MAX_PX_SIDE - максимальный размер стороны изображения в пикселях (например, 800px или 800). Значение можно оставить пустым.
IMAGE_UPLOADER_EXT - список поддерживаемых форматов через запятую (например, jpg,jpeg,png)

#### Работа с Vue
1. Конфигурация фронт-енд части проекта хранится в файле `webpack.config.js` в корне проекта
1. Исходные файлы хранятся в папке `public/src`
1. Транспилированные файлы хранятся в папке `public/build`
1. Чтобы подключить собранные файлы из папке `build` в шаблоне Twig необходимо добавить следующее
    > {{ encore_entry_link_tags('app') }}  - для подключения стилей <br />
      {{ encore_entry_script_tags('app') }} - для подключения JS-файлов
1. Команды для сборки файлов
    > npm run build - собрать файлы после внесения изменений в исходники <br />
      npm run watch - запустить вотчер и собирать файлы на лету <br />
      npm run dev - пересобрать Encore после внесения изменений в webpack.config.js
                              
#### Работа с flash-извещениями
Извещения добавляются в конфигурационный файл mnt/app/config/flash-messages.yaml
Чтобы получить извещение в контроллере, необходимо использовать метод getFlashMessage($key, $options) трейта FlashMessagesTrait.
key - ключ, по которому можем получить извещение из конфига.
options - массив элементов, которые подставятся в извещение заместо символа "%s"

#### Консольные команды
- `bin/console app:design-stat:calculate` - Расчет данных глобальной статистики по дизайнам для байера
- `bin/console app:algorithm-stat:calculate` - Расчет данных глобальной статистики по алгоритмам для байера
- `bin/console app:teaser:statistics`     - Расчет данных глобальной статистики по тизерам для байера
- `bin/console app:teasers-ecpm:calculate` - Расчет eCPM для тизеров
- `bin/console app:news-ecpm:calculate` - Расчет eCPM для новостей
- `bin/console app:news-stat:calculate`  - Расчет данных общей глобальной статистики по новостям для байера и администратора
- `bin/console app:news-stat-buyer:calculate`  - Расчет данных общей глобальной статистики по новостям для байера
- `bin/console app:exchange-currency-rate:update`  - Добавление и обновление обменного курса валют. В качестве опционального параметра принимает дату(date) в формате dd.mm.YYYY

#### Урлы для ajax обращений
##### Урлы для модуля тизеры
- `/ajax-teasers/{page}` - На вход принимает int {page} - номер страницы, без указания страницы по дефолту будет считаться что страница - 1, отдает топ тизеров. 
- `/ajax-news-teasers/{news}/{type}/{page}` - На вход принимает int {news} - id новости, {type} - тип страницы с которой осуществлен запрос (short или full), int {page} - номер страницы,
 без указания страницы по дефолту будет считаться что страница - 1, отдает тизеры для новости. 
##### Урлы для модуля новости
- `/ajax-news/{page}` - На вход принимает int {page} - номер страницы, без указания страницы по дефолту будет считаться что страница - 1, отдает топ новостей. 
- `/ajax-news-categories/{slug}/{page}` - На вход принимает {slug} категории и int {page} - номер страницы, без указания страницы по дефолту будет считаться что страница - 1, отдает топ новостей по категории.
